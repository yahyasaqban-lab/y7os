#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  y7-lang â€” Y7 OS Language Switcher
#  Switch between Arabic and English interface
#  github.com/yahyasaqban-lab/y7os
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -e

GREEN='\033[0;32m'; CYAN='\033[0;36m'; YELLOW='\033[1;33m'
BOLD='\033[1m'; NC='\033[0m'

Y7_LANG_CONF="${Y7_LANG_CONF:-/etc/y7/lang.conf}"
Y7_OLLAMA_HOST="${Y7_OLLAMA_HOST:-http://localhost:11434}"

log_ok()   { echo -e "  ${GREEN}âœ…${NC}  $1"; }
log_info() { echo -e "  ${CYAN}â„¹ï¸ ${NC}  $1"; }
log_warn() { echo -e "  ${YELLOW}âš ï¸ ${NC}  $1"; }

current_lang() {
  [ -f "$Y7_LANG_CONF" ] && grep "^LANG=" "$Y7_LANG_CONF" | cut -d= -f2 | tr -d '"' | cut -c1-2 || echo "en"
}

set_arabic() {
  echo ""
  echo -e "  ${BOLD}Setting Y7 OS to Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)...${NC}"
  echo ""

  sudo mkdir -p /etc/y7

  # Write lang config
  sudo tee "$Y7_LANG_CONF" > /dev/null << 'EOF'
LANG="ar_KW.UTF-8"
LANGUAGE="ar_KW:ar"
LC_ALL="ar_KW.UTF-8"
Y7_LANG="ar"
Y7_DIRECTION="rtl"
EOF

  # Apply to current shell session
  export LANG="ar_KW.UTF-8"
  export LANGUAGE="ar_KW:ar"
  export Y7_LANG="ar"

  # Install Arabic fonts if missing
  if command -v apt-get &>/dev/null; then
    dpkg -l fonts-noto-core &>/dev/null 2>&1 || \
      sudo apt-get install -y fonts-noto-core fonts-noto-extra 2>/dev/null && \
      log_ok "Noto Arabic fonts installed" || true
  fi

  # Set Arabic system prompt for Ollama
  sudo mkdir -p /etc/y7
  sudo tee /etc/y7/system-prompt.txt > /dev/null << 'EOF'
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª. ÙŠÙØ¶Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­Ø¯Ø« Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
Ø£Ø¬Ø¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø§ Ù„Ù… ÙŠØ·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø°Ù„Ùƒ.
ÙƒÙ† ÙˆØ§Ø¶Ø­Ø§Ù‹ ÙˆÙ…ÙˆØ¬Ø²Ø§Ù‹ ÙˆÙ…ÙÙŠØ¯Ø§Ù‹.
EOF

  # Update Open WebUI default language if running
  if curl -s http://localhost:8080 &>/dev/null; then
    log_info "Open WebUI detected â€” change language in Settings â†’ Interface â†’ Language"
  fi

  log_ok "Language set to Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)"
  log_ok "System prompt updated â€” AI will respond in Arabic"
  echo ""
  echo -e "  ${BOLD}ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ðŸŽ‰${NC}"
  echo ""
  echo -e "  ${CYAN}y7-ai arabic${NC}    â†’ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø£ÙØ¶Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø¹Ø±Ø¨ÙŠ"
  echo -e "  ${CYAN}y7-ai phi3${NC}      â†’ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø¯Ø¹Ù… Ø¹Ø±Ø¨ÙŠ Ø¬Ø²Ø¦ÙŠ)"
  echo ""
  echo -e "  ${YELLOW}â„¹ï¸ ${NC}  Ø§ÙØªØ­ terminal Ø¬Ø¯ÙŠØ¯ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"
  echo ""
}

set_english() {
  echo ""
  echo -e "  ${BOLD}Setting Y7 OS to English...${NC}"
  echo ""

  sudo mkdir -p /etc/y7

  sudo tee "$Y7_LANG_CONF" > /dev/null << 'EOF'
LANG="en_US.UTF-8"
LANGUAGE="en_US:en"
LC_ALL="en_US.UTF-8"
Y7_LANG="en"
Y7_DIRECTION="ltr"
EOF

  export LANG="en_US.UTF-8"
  export Y7_LANG="en"

  sudo tee /etc/y7/system-prompt.txt > /dev/null << 'EOF'
You are a helpful AI assistant. Answer clearly and concisely in English.
EOF

  log_ok "Language set to English"
  log_ok "System prompt updated"
  echo ""
  echo -e "  ${CYAN}y7-ai${NC}     â†’ Start AI chat in English"
  echo ""
}

set_auto() {
  echo ""
  echo -e "  ${BOLD}Detecting system language...${NC}"
  local sys_lang="${LANG:-en}"
  if echo "$sys_lang" | grep -qi "ar"; then
    log_info "Detected Arabic system locale"
    set_arabic
  else
    log_info "Detected non-Arabic locale â€” using English"
    set_english
  fi
}

show_status() {
  local lang=$(current_lang)
  echo ""
  echo -e "${BOLD}  Y7 OS Language Status${NC}"
  echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo -e "  Current language: ${CYAN}$lang${NC}"
  [ -f "$Y7_LANG_CONF" ] && cat "$Y7_LANG_CONF" | sed 's/^/  /' || echo "  (no config â€” defaults to English)"
  echo ""
  [ -f /etc/y7/system-prompt.txt ] && {
    echo -e "  ${BOLD}AI System Prompt:${NC}"
    cat /etc/y7/system-prompt.txt | sed 's/^/  /'
  }
  echo ""
}

show_help() {
  echo ""
  echo -e "${BOLD}  y7-lang â€” Y7 OS Language Switcher${NC}"
  echo ""
  echo -e "  ${CYAN}y7-lang ar${NC}       Switch to Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)"
  echo -e "  ${CYAN}y7-lang en${NC}       Switch to English"
  echo -e "  ${CYAN}y7-lang auto${NC}     Detect from system locale"
  echo -e "  ${CYAN}y7-lang status${NC}   Show current language"
  echo ""
}

case "${1:-help}" in
  ar|arabic|Ø¹Ø±Ø¨ÙŠ)    set_arabic ;;
  en|english)        set_english ;;
  auto)              set_auto ;;
  status)            show_status ;;
  help|--help|-h)    show_help ;;
  *) echo "Unknown: $1"; show_help ;;
esac
